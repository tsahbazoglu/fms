<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:p="http://primefaces.org/ui"
      xmlns:mygrid="http://java.sun.com/jsf/composite/telmangrid"
      xmlns:c="http://java.sun.com/jsp/jstl/core"
      >
    <h:head>
        <title></title>
        <script>
            function setStatusToSaved() {
                var hiddenTextStatusSaved = $(document.getElementById("id-tab-view:nd-form:id-hidden-text-saved-status"));
                hiddenTextStatusSaved.prop("value", true);
            }
            function checkSavedStatus() {
                var hiddenTextStatusSaved = $(document.getElementById("id-tab-view:nd-form:id-hidden-text-saved-status"));
                if (hiddenTextStatusSaved.prop("value") == "false"
                        || hiddenTextStatusSaved.prop("value") == false) {
                    PF("wv_pivot_not_saved_data").show();
                } else {
                    rcPivotSendForms();
                    PF("wv_pivot_not_saved_data").hide();
                }
            }
            function hideNotSavedDlg() {
                PF("wv_pivot_not_saved_data").hide();
            }

        </script>
    </h:head>

    <p:dialog  
        resizable="false"
        closeOnEscape="true"
        closable="true"
        widgetVar="wv_pivot_not_saved_data"
        >        
        <p:panel>
            <br/>
            <p:outputLabel value="Kayıt edilmeyen veri değişiklikleri tespit edildi"/>
            <br/>
            <br/>
            <br/>
        </p:panel>         
    </p:dialog>


    <h:form id="nd-form">
        <p:toolbar 
            id="id-nd-toolbar"
            rendered="#{not esignViewCtrl.preventedMultiTab}"
            style="width: 94%"
            >
            <f:facet name="left">
                <h:panelGrid columns="6">
                    <p:button  
                        icon="pi pi-home" 
                        disabled="true">
                    </p:button>

                    <p:commandButton 
                        value="Kaydet"
                        rendered="#{formService.myForm.myActions.save}"
                        style="width: 150px;"
                        action="#{pivotModifierCtrl.provideCrossCheck}"
                        update="#{updateAjaxMB.btnNdSave}"
                        oncomplete="setStatusToSaved();hideNotSavedDlg();"
                        />
                    <p:button
                        value="#{formService.myForm.myActions.sendFormAction.enableResult.caption}" 
                        rendered="#{formService.myForm.myActions.sendForms}"
                        onclick="checkSavedStatus();
                                return false;"
                        >
                    </p:button>
                    <p:remoteCommand 
                        name="rcPivotSendForms"
                        value="#{formService.myForm.myActions.sendFormAction.enableResult.caption}" 
                        actionListener="#{pivotModifierCtrl.sendForm}" 
                        rendered="#{formService.myForm.myActions.sendForms}"
                        update="#{updateAjaxMB.btnNdSendForms}"
                        />
                    <p:commandButton 
                        value="Bu sayfa ile ilgili açıklamalar için tıklayınız" 
                        action="#{pivotModifierCtrl.showAllNote}" 
                        style="color: red;font-weight: bold;white-space: nowrap;"
                        rendered="#{pivotModifierCtrl.selectedFormUserNote}"
                        update=":idMessageDialog"
                        />
                    <p:commandButton 
                        value="Excele Aktar" 
                        rendered="#{formService.myForm.myActions.download}"
                        action="#{pivotModifierCtrl.downloadCsvFile}" 
                        style="white-space: nowrap;"
                        />
                    <p:commandButton 
                        value="E-İmza Süreci" 
                        action="#{pivotModifierCtrl.showEimza22}" 
                        rendered="#{formService.myForm.myActions.eimza2D}"
                        update=":idMessageDialog,:id_nd_esign_dialog"
                        />  
                    <h:inputHidden
                        id="id-hidden-text-json-data-to-model" 
                        value="#{pivotModifierCtrl.pivotDataModelEdit.jsonDataToModel}"
                        />
                    <h:inputHidden
                        id="id-hidden-text-saved-status" 
                        value="false"
                        />
                </h:panelGrid>
            </f:facet>
        </p:toolbar>
    </h:form> 

    <br/>

    <p:outputLabel value="Güncel Dönem Verisi" style="font-size: 22px;font-weight: bolder;"/>
    <br/>
    <br/>
    <h:form id="ndFilterForm">
        <table>
            <tr>
                <ui:repeat value="#{pivotModifierCtrl.zetDimension}" var="filterFieldStructure">
                    <td>
                        <p:outputLabel value="#{filterFieldStructure.shortName} : "/>
                        <p:selectOneMenu  
                            value="#{filterService.guiFilterCurrent[filterFieldStructure.field]}"
                            converter="#{filterFieldStructure.myconverter}"
                            rendered="#{'member' eq filterFieldStructure.key}"
                            filter="true" 
                            filterMatchMode="contains"   
                            caseSensitive="true"
                            style="width: 300px;"
                            >
                            <p:ajax 
                                listener="#{pivotModifierCtrl.valueChangeListenerZet}" 
                                update="#{updateAjaxMB.filterNdData}"
                                />
                            <f:selectItems value="#{filterFieldStructure.listOfValues}"/>
                            <f:attribute name="myKey" value="#{filterFieldStructure.key}"/>
                        </p:selectOneMenu>
                        <p:selectOneMenu  
                            value="#{filterService.guiFilterCurrent[filterFieldStructure.field]}"
                            converter="#{filterFieldStructure.myconverter}"
                            rendered="#{'period' eq filterFieldStructure.key}"
                            style="width: 100px;"
                            >
                            <p:ajax 
                                listener="#{pivotModifierCtrl.valueChangeListenerZet}" 
                                update="#{updateAjaxMB.filterNdDataAndTop}"/>
                            <f:selectItems value="#{filterFieldStructure.listOfValues}"/>
                            <f:attribute name="myKey" value="#{filterFieldStructure.key}"/>
                        </p:selectOneMenu>
                        <p:selectOneMenu  
                            value="#{filterService.guiFilterCurrent[filterFieldStructure.field]}"
                            converter="#{filterFieldStructure.myconverter}"
                            rendered="#{'periodFilter' eq filterFieldStructure.key}"
                            style="width: 100px;"
                            >
                            <p:ajax 
                                listener="#{pivotModifierCtrl.valueChangeListenerZet}" 
                                update="#{updateAjaxMB.filterNdData}"/>
                            <f:selectItems value="#{filterFieldStructure.listOfValues}"/>
                            <f:attribute name="myKey" value="#{filterFieldStructure.key}"/>
                        </p:selectOneMenu>
                        <p:selectOneMenu  
                            value="#{filterService.guiFilterCurrent[filterFieldStructure.field]}"
                            converter="#{filterFieldStructure.myconverter}"
                            rendered="#{'template' eq filterFieldStructure.key}"
                            style="width: 100px;"
                            >
                            <p:ajax                                 
                                listener="#{pivotModifierCtrl.valueChangeListenerZet}" 
                                update="#{updateAjaxMB.filterNdData}"/>
                            <f:selectItems value="#{filterFieldStructure.listOfValues}"/>
                            <f:attribute name="myKey" value="#{filterFieldStructure.key}"/>
                        </p:selectOneMenu>
                    </td>
                </ui:repeat>

                <c:forEach items="#{formService.myForm.fieldsRowKeys}" var="fieldKey">
                    <td>
                        <h:panelGrid columns="1">
                            <h:outputText
                                value="#{pivotModifierCtrl.componentMap[fieldKey]['label']}" 
                                escape="false"
                                style="#{pivotModifierCtrl.componentMap[fieldKey]['style']}"
                                rendered="#{pivotModifierCtrl.componentMap[fieldKey]['rendered']}"
                                >
                            </h:outputText>
                            <p:selectOneMenu
                                value="#{pivotModifierCtrl.rowObject[fieldKey]}"
                                label="#{pivotModifierCtrl.componentMap[fieldKey]['label']}" 
                                rendered="#{'selectOneMenu' eq  pivotModifierCtrl.componentMap[fieldKey]['componentType'] 
                                            and pivotModifierCtrl.componentMap[fieldKey]['rendered']}"
                                converter="#{pivotModifierCtrl.componentMap[fieldKey].myconverter}"
                                >
                                <p:ajax 
                                    listener="#{pivotModifierCtrl.submitRowData}" 
                                    update="#{updateAjaxMB.filterNdData}"
                                    />
                                <f:selectItems value="#{pivotModifierCtrl.componentMap[fieldKey].items}"/>
                            </p:selectOneMenu>   
                        </h:panelGrid>
                    </td>  
                </c:forEach>   
            </tr>
        </table>
    </h:form>

    <h:panelGroup id="currentMyGridReadOnly">
        <mygrid:mygridHistory 
            id="idCurrentMyGridReadOnly"
            rowHeaderWidh="#{pivotModifierCtrl.pivotDataModelRead.handsonRowHeaderWidth}"
            colWidths="#{pivotModifierCtrl.pivotDataModelRead.handsonColWidths}"
            columns="#{pivotModifierCtrl.pivotDataModelRead.columns}" 
            rows="#{pivotModifierCtrl.pivotDataModelRead.rows}" 
            cell="#{pivotModifierCtrl.pivotDataModelRead.cell}"
            rendered="#{not pivotModifierCtrl.editable}"            
            /> 
    </h:panelGroup>

    <h:panelGroup id="currentMyGrid">
        <style>
            .handsontable table thead th {
                white-space: pre-line;
                /*max-width: 10px;*/
            }
        </style>
        <mygrid:mygrid 
            id="idCurrentMyGrid"
            rowHeaderWidh="#{pivotModifierCtrl.pivotDataModelEdit.handsonRowHeaderWidth}"
            colWidths="#{pivotModifierCtrl.pivotDataModelEdit.handsonColWidths}"
            data="#{pivotModifierCtrl.pivotDataModelEdit.jsonData}"
            rowHeaders="#{pivotModifierCtrl.pivotDataModelEdit.jsonRowHeaders}"
            colHeaders="#{pivotModifierCtrl.pivotDataModelEdit.jsonColHeaders}"
            colRenderers="#{pivotModifierCtrl.pivotDataModelEdit.jsonColRenderers}"
            rendered="#{pivotModifierCtrl.editable}"
            />
    </h:panelGroup>
    <br/>
    <br/>

    <script>
        $(document.getElementById("id-tab-view:currentMyGrid")).bind("click", function (event) {
            hideNotSavedDlg();
        })
    </script>


</html>
<!--
                           A html select option element trims the white spaces by default.
                           this is not the issue of jsf.
                           so even if we have no jsf component we have to replace 
                           all white spaces in option element labels to &nbsp;
                           
                           At this phace we are success with h:selectOneMenu too,
                           but it does not taken into account when we use ice:selectOneMenu.
                           
                           So, this is the main reason why we use h:selectoneMenu 
                           instead of ice:selectOneMenu here.
                           
                           That is all.
-->